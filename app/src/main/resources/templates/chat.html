<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Real-Time Chat with Rooms & Images</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: #f8f9fa; }
        .chat-card { max-width: 600px; margin: auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); border-radius: 16px; }
        .chat-header { background-color: #0d6efd; color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 1rem; text-align: center; }
        #chat { height: 350px; overflow-y: auto; padding: 1rem; background-color: #ffffff; }
        .message { margin-bottom: 10px; padding: 0.5rem 1rem; border-radius: 12px; background-color: #f1f3f5; max-width: 80%; clear: both; }
        .message.own { background-color: #d1f7d6; margin-left: auto; text-align: right; }
        .message img { max-width: 200px; border-radius: 10px; display: block; margin: 5px 0; }
        .timestamp { font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem; }
        .chat-footer { padding: 1rem; background-color: #f8f9fa; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }
        .btn-send, .btn-image { border-radius: 12px; }
        input.form-control { border-radius: 12px; }
        .preview { text-align: center; margin-bottom: 10px; }
        .preview img { max-width: 150px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 10px; }
    </style>
</head>

<body>
<div class="container py-5">
    <div class="chat-card bg-white">
        <div class="chat-header">
            <h4 class="mb-2">üí¨ Real-Time Chat (Rooms + Images)</h4>
            <div class="input-group input-group-sm">
                <select id="roomSelect" class="form-select">
                    <option value="" disabled selected>-- Select Chat Room --</option>
                </select>
                <input id="newRoomName" type="text" class="form-control" placeholder="New room name...">
                <button id="createRoomBtn" class="btn btn-light">‚ûï</button>
            </div>
        </div>

        <div id="chat"></div>

        <!-- Image preview -->
        <div id="previewContainer" class="preview d-none">
            <img id="imagePreview" src="" alt="Preview">
        </div>

        <div class="chat-footer">
            <div class="mb-3">
                <input id="senderInput" type="text" class="form-control" placeholder="Enter your name..." />
            </div>

            <div class="input-group">
                <input id="messageInput" type="text" class="form-control" placeholder="Type a message..." />
                <input type="file" id="imageInput" accept="image/*" class="d-none" />
                <button id="imageButton" class="btn btn-outline-secondary btn-image ms-2">üñºÔ∏è</button>
                <button id="sendMessage" class="btn btn-primary btn-send ms-2">Send üöÄ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let stompClient = null;
    let currentUser = '';
    let currentRoomId = null;
    let uploadedImageUrl = null;

    async function loadRooms() {
      const response = await fetch('/api/rooms');
      const rooms = await response.json();
      const roomSelect = document.getElementById("roomSelect");
      roomSelect.innerHTML = '<option value="" disabled selected>-- Select Chat Room --</option>';
      rooms.forEach(room => {
        const opt = document.createElement("option");
        opt.value = room.id;
        opt.textContent = room.name;
        roomSelect.appendChild(opt);
      });
    }

    async function createRoom() {
      const name = document.getElementById("newRoomName").value.trim();
      if (!name) return alert("Enter a room name!");
      const response = await fetch('/api/rooms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if (response.ok) {
        document.getElementById("newRoomName").value = '';
        await loadRooms();
      }
    }

    function connect(roomId) {
      if (stompClient) stompClient.disconnect();
      const socket = new SockJS("/ws");
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function() {
        console.log("‚úÖ Connected to room:", roomId);
        stompClient.subscribe(`/topic/messages/${roomId}`, function(message) {
          showMessage(JSON.parse(message.body));
        });
      });
    }

    function showMessage(message) {
      const chat = document.getElementById("chat");
      const msgElem = document.createElement("div");
      const isOwn = message.sender === currentUser;
      msgElem.className = `message ${isOwn ? 'own' : 'other'}`;
      msgElem.innerHTML = `<div><strong>${message.sender}</strong>:</div>`;

      if (message.type === "IMAGE" && message.imageUrl) {
        msgElem.innerHTML += `<img src="${message.imageUrl}" alt="Image message">`;
      } else if (message.content) {
        msgElem.innerHTML += `<div>${message.content}</div>`;
      }

      msgElem.innerHTML += `<div class="timestamp">${new Date(message.timestamp || Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      chat.appendChild(msgElem);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
      const sender = document.getElementById("senderInput").value.trim();
      const content = document.getElementById("messageInput").value.trim();
      if (!sender) return alert("Enter your name!");
      if (!currentRoomId) return alert("Select a chat room first!");
      if (!content && !uploadedImageUrl) return;

      currentUser = sender;

      const chatMessage = {
        sender,
        content: content || "",
        roomId: currentRoomId,
        type: uploadedImageUrl ? "IMAGE" : "CHAT",
        imageUrl: uploadedImageUrl || null
      };

      stompClient.send("/app/sendMessages", {}, JSON.stringify(chatMessage));

      document.getElementById("messageInput").value = "";
      uploadedImageUrl = null;
      document.getElementById("previewContainer").classList.add("d-none");
    }

    // üî• Handle image upload to ImageUploadController (MongoDB)
    const imageInput = document.getElementById("imageInput");
    const imageButton = document.getElementById("imageButton");

    imageButton.onclick = () => imageInput.click();
    imageInput.onchange = async function() {
      const file = this.files[0];
      const sender = document.getElementById("senderInput").value.trim();
      if (!file) return;
      if (!sender) return alert("Enter your name first!");
      if (!currentRoomId) return alert("Select a room first!");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("sender", sender);
      formData.append("roomId", currentRoomId);

      try {
        const response = await fetch("/api/upload", {
          method: "POST",
          body: formData
        });

        if (!response.ok) throw new Error("Upload failed");

        // ‚úÖ Your backend returns plain text image URL
        const imageUrl = await response.text();
        uploadedImageUrl = imageUrl;

        const preview = document.getElementById("imagePreview");
        preview.src = uploadedImageUrl;
        document.getElementById("previewContainer").classList.remove("d-none");

        console.log("‚úÖ Uploaded image:", uploadedImageUrl);
      } catch (err) {
        console.error(err);
        alert("‚ùå Image upload failed!");
      }
    };

    document.getElementById("sendMessage").onclick = sendMessage;
    document.getElementById("createRoomBtn").onclick = createRoom;
    document.getElementById("roomSelect").onchange = function() {
      currentRoomId = this.value;
      document.getElementById("chat").innerHTML = "";
      connect(currentRoomId);
    };
    document.getElementById("messageInput").addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    window.onload = loadRooms;
</script>


</body>
</html>
